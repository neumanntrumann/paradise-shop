<!DOCTYPE html>
<html>
<head>
  <title>Your Cart</title>
  <style>
    /* ... keep all your existing CSS exactly as is ... */
  </style>
</head>
<body>

  <!-- Hamburger menu -->
  <div id="menuToggle" aria-label="Toggle navigation menu" role="button" tabindex="0">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <!-- Sliding side menu -->
  <nav id="sideMenu" aria-label="Main navigation menu">
    <a href="index.html">Home</a>
    <a href="balance.html">Balance</a>
    <a href="marketplace.html">Market</a>
    <a href="cart.html">Cart</a>
    <a href="orders.html">Orders</a>
    <a href="more.html">More</a>
    <a href="logout.html">Logout</a>
  </nav>

  <!-- Profile Dropdown -->
  <div id="profileDropdownContainer">
    <div id="profileIcon" tabindex="0" role="button" aria-label="User profile menu" aria-expanded="false" title="Profile">üë§</div>
    <div id="profileDropdown" role="menu" aria-label="User profile menu">
      <div id="profileInfo"></div>
      <a href="balance.html">Load Funds</a>
      <a href="index.html">Shop</a>
      <a href="cart.html">Cart</a>
      <a href="orders.html">Orders</a>
      <a href="logout.html">Logout</a>
    </div>
  </div>

  <h1>Your Cart</h1>

  <!-- Your existing cart container -->
  <div id="cart-items"></div>
  <div id="orderTotal"></div>
  <button id="checkoutBtn" disabled>üí∞ Proceed to Checkout</button>

  <!-- New cart list container for the additional fetchUserCart script -->
  <div id="cart-list">Loading cart...</div>

  <script>
    const profileIcon = document.getElementById('profileIcon');
    const profileDropdown = document.getElementById('profileDropdown');
    const profileInfoDiv = document.getElementById('profileInfo');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const cartContainer = document.getElementById('cart-items');
    const orderTotalDiv = document.getElementById('orderTotal');

    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');

    // Hamburger toggle logic
    function toggleMenu() {
      sideMenu.classList.toggle('active');
    }
    menuToggle.addEventListener('click', toggleMenu);
    menuToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleMenu();
      }
    });
    window.addEventListener('click', (e) => {
      if (!sideMenu.contains(e.target) && !menuToggle.contains(e.target)) {
        sideMenu.classList.remove('active');
      }
    });

    // Profile dropdown toggle
    function toggleProfileDropdown() {
      const isActive = profileDropdown.classList.toggle('active');
      profileIcon.setAttribute('aria-expanded', isActive);
    }
    profileIcon.addEventListener('click', toggleProfileDropdown);
    profileIcon.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleProfileDropdown();
      }
    });
    window.addEventListener('click', (e) => {
      if (!profileIcon.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.remove('active');
        profileIcon.setAttribute('aria-expanded', false);
      }
    });

    // Helper to fetch JSON with error handling
    async function fetchJson(url, options = {}) {
      const resp = await fetch(url, options);
      if (!resp.ok) {
        throw new Error(`HTTP error! Status: ${resp.status}`);
      }
      return await resp.json();
    }

    // Check if logged in by calling backend session endpoint
    async function checkSession() {
      try {
        const session = await fetchJson('/api/session');
        return session.user; // assume { user: 'username' }
      } catch (e) {
        alert('Please log in to view your cart.');
        window.location.href = 'login.html';
        return null;
      }
    }

    // Load profile info for dropdown
    async function loadProfile() {
      try {
        const profile = await fetchJson('/api/user/profile');
        profileInfoDiv.innerHTML = `
          <strong>${profile.username}</strong><br>
          Balance: $${profile.balance.toFixed(2)}<br>
          Spent: $${profile.totalSpent.toFixed(2)}<br>
          Joined: ${profile.joinDate}<br>
          Orders: ${profile.orderCount}
        `;
      } catch (e) {
        profileInfoDiv.textContent = 'Failed to load profile info.';
      }
    }

    // Load cart items from backend (your existing function)
    async function loadCart() {
      try {
        const cart = await fetchJson('/api/cart');
        renderCart(cart);
      } catch (e) {
        cartContainer.innerHTML = '<p>Failed to load cart. Please try again later.</p>';
        checkoutBtn.disabled = true;
      }
    }

    // Render cart items (your existing function)
    function renderCart(cart) {
      cartContainer.innerHTML = '';
      if (cart.length === 0) {
        cartContainer.innerHTML = '<p>Your cart is empty.</p>';
        orderTotalDiv.textContent = '';
        checkoutBtn.disabled = true;
        return;
      }

      let total = 0;
      cart.forEach(item => {
        total += item.price;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <strong>${item.name}</strong> - $${item.price.toFixed(2)}
          <button class="remove-btn" aria-label="Remove ${item.name} from cart" data-id="${item.id}">‚ùå Remove</button>
        `;
        cartContainer.appendChild(div);
      });
      orderTotalDiv.textContent = `Total: $${total.toFixed(2)}`;
      checkoutBtn.disabled = false;

      // Attach remove button handlers
      const removeButtons = cartContainer.querySelectorAll('.remove-btn');
      removeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const itemId = btn.getAttribute('data-id');
          removeFromCart(itemId);
        });
      });
    }

    // Remove item from cart via backend
    async function removeFromCart(itemId) {
      try {
        await fetch(`/api/cart/item/${itemId}`, { method: 'DELETE' });
        await loadCart(); // reload cart after removal
      } catch (e) {
        alert('Failed to remove item from cart.');
      }
    }

    // Checkout via backend
    checkoutBtn.onclick = async () => {
      try {
        const resp = await fetch('/api/checkout', { method: 'POST' });
        if (!resp.ok) throw new Error('Checkout failed');
        alert('Order placed successfully!');
        window.location.href = 'orders.html';
      } catch (e) {
        alert('Checkout failed. Please try again or add funds.');
      }
    };

    // New function you provided to fetch user cart and display in #cart-list
    async function fetchUserCart() {
      try {
        const response = await fetch('/api/userdata');
        if (!response.ok) throw new Error('Failed to fetch user data');

        const data = await response.json();

        const cartList = document.getElementById('cart-list');
        if (data.cart.length === 0) {
          cartList.innerHTML = '<p>Your cart is empty.</p>';
          return;
        }

        cartList.innerHTML = '';
        data.cart.forEach((item, i) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'cart-item';
          itemDiv.textContent = `${item.name} - $${item.price.toFixed(2)}`;
          cartList.appendChild(itemDiv);
        });
      } catch (error) {
        console.error(error);
        document.getElementById('cart-list').innerHTML = '<p>Error loading cart.</p>';
      }
    }

    // Example function to add an item (you need to wire this to your UI buttons)
    async function addItemToCart(item) {
      try {
        const response = await fetch('/api/cart/add', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item }),
        });

        const data = await response.json();

        if (response.ok) {
          alert('Item added to cart');
          fetchUserCart();  // refresh cart
        } else {
          alert(data.error || 'Failed to add item');
        }
      } catch (error) {
        alert('Error connecting to server');
        console.error(error);
      }
    }

    // Initialize page
    (async () => {
      const user = await checkSession();
      if (!user) return; // redirected to login

      await loadProfile();
      await loadCart();
      fetchUserCart(); // Also fetch the cart via your new script
    })();

  </script>
</body>
</html>
