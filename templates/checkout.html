<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div
    id="menuToggle"
    aria-label="Toggle navigation menu"
    role="button"
    tabindex="0"
    aria-expanded="false"
    aria-controls="sideMenu"
  >
    <span></span>
    <span></span>
    <span></span>
  </div>

  <nav id="sideMenu" aria-label="Main navigation menu" tabindex="-1" style="display:none;">
    <a href="/">Home</a>
    <a href="/balance">Balance</a>
    <a href="/marketplace">Market</a>
    <a href="/cart" aria-current="page">Cart</a>
    <a href="/orders">Orders</a>
    <a href="/more">More</a>
    <a href="/logout">Logout</a>
  </nav>

  <div id="profileDropdownContainer">
    <div
      id="profileIcon"
      tabindex="0"
      role="button"
      aria-label="User profile menu"
      aria-expanded="false"
      aria-controls="profileDropdown"
      title="Profile"
    >
      üë§
    </div>
    <div id="profileDropdown" role="menu" aria-label="User profile menu">
      <div id="profileInfo" aria-live="polite" aria-atomic="true"></div>
      <a href="/balance" role="menuitem" tabindex="-1">Load Funds</a>
      <a href="/" role="menuitem" tabindex="-1">Shop</a>
      <a href="/cart" role="menuitem" tabindex="-1">Cart</a>
      <a href="/orders" role="menuitem" tabindex="-1">Orders</a>
      <a href="/logout" role="menuitem" tabindex="-1">Logout</a>
    </div>
  </div>

  <main>
    <h1>Your Cart</h1>
    <section
      id="cart-items"
      aria-live="polite"
      aria-relevant="additions removals"
    ></section>
    <div id="orderTotal" aria-live="polite" aria-atomic="true"></div>

    <!-- Updated checkout button with id as requested -->
    <button id="checkoutButton" aria-disabled="true">üí∞ Proceed to Checkout</button>
  </main>

  <script>
    const email = sessionStorage.getItem('loggedInUser');
    if (!email) {
      alert('Please log in to view your cart.');
      window.location.href = '/index';
    }

    const cartContainer = document.getElementById('cart-items');
    const orderTotalDiv = document.getElementById('orderTotal');
    const checkoutButton = document.getElementById('checkoutButton');

    async function fetchCart() {
      const res = await fetch(`/api/cart/${email}`);
      if (!res.ok) return;
      const cart = await res.json();
      renderCart(cart);
    }

    function renderCart(cart) {
      cartContainer.innerHTML = '';
      let total = 0;

      if (!cart.length) {
        cartContainer.innerHTML = '<p>Your cart is empty.</p>';
        orderTotalDiv.textContent = '';
        checkoutButton.disabled = true;
        checkoutButton.setAttribute('aria-disabled', 'true');
        return;
      }

      cart.forEach((item, index) => {
        total += item.price;
        const div = document.createElement('div');
        div.className = 'item';
        div.tabIndex = 0;
        div.innerHTML = `
          <strong>${item.name}</strong> - $${item.price.toFixed(2)}
          <button class="remove-btn" aria-label="Remove ${item.name} from cart" data-index="${index}">‚ùå Remove</button>
        `;
        cartContainer.appendChild(div);
      });

      orderTotalDiv.textContent = `Total: $${total.toFixed(2)}`;
      checkoutButton.disabled = false;
      checkoutButton.setAttribute('aria-disabled', 'false');

      document.querySelectorAll('.remove-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.getAttribute('data-index'));
          await removeFromCart(idx);
        });
      });
    }

    async function removeFromCart(index) {
      const res = await fetch(`/api/cart/${email}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ removeIndex: index }),
      });
      if (res.ok) fetchCart();
    }

    // Your new checkout API call logic here:
    async function placeOrder() {
      try {
        const response = await fetch(`/api/checkout/${email}`, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
          alert('Order placed successfully! New balance: $' + data.balance.toFixed(2));
          window.location.href = '/orders';
        } else {
          alert(data.error || 'Checkout failed');
        }
      } catch (error) {
        alert('Error connecting to server');
        console.error(error);
      }
    }

    checkoutButton.addEventListener('click', placeOrder);

    // Hamburger menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');

    menuToggle.addEventListener('click', () => {
      const expanded = menuToggle.getAttribute('aria-expanded') === 'true';
      menuToggle.setAttribute('aria-expanded', !expanded);
      sideMenu.style.display = expanded ? 'none' : 'block';
    });

    fetchCart();
  </script>
</body>
</html>
