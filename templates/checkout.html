<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div
    id="menuToggle"
    aria-label="Toggle navigation menu"
    role="button"
    tabindex="0"
    aria-expanded="false"
    aria-controls="sideMenu"
  >
    <span></span>
    <span></span>
    <span></span>
  </div>

  <nav id="sideMenu" aria-label="Main navigation menu" tabindex="-1" style="display:none;">
    <a href="/">Home</a>
    <a href="/balance">Balance</a>
    <a href="/marketplace">Market</a>
    <a href="/cart" aria-current="page">Cart</a>
    <a href="/orders">Orders</a>
    <a href="/more">More</a>
    <a href="/logout">Logout</a>
  </nav>

  <div id="profileDropdownContainer">
    <div
      id="profileIcon"
      tabindex="0"
      role="button"
      aria-label="User profile menu"
      aria-expanded="false"
      aria-controls="profileDropdown"
      title="Profile"
    >
      üë§
    </div>
    <div id="profileDropdown" role="menu" aria-label="User profile menu">
      <div id="profileInfo" aria-live="polite" aria-atomic="true">Loading...</div>
      <a href="/balance" role="menuitem" tabindex="-1">Load Funds</a>
      <a href="/" role="menuitem" tabindex="-1">Shop</a>
      <a href="/cart" role="menuitem" tabindex="-1">Cart</a>
      <a href="/orders" role="menuitem" tabindex="-1">Orders</a>
      <a href="/logout" role="menuitem" tabindex="-1">Logout</a>
    </div>
  </div>

  <main>
    <h1>Your Cart</h1>
    <section
      id="cart-items"
      aria-live="polite"
      aria-relevant="additions removals"
    ></section>
    <div id="orderTotal" aria-live="polite" aria-atomic="true"></div>

    <!-- Updated checkout button with id as requested -->
    <button id="checkoutButton" aria-disabled="true">üí∞ Proceed to Checkout</button>
  </main>

  <script>
    // Check for JWT token in localStorage
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please log in first.');
      window.location.href = '/login';
    }

    const profileIcon = document.getElementById('profileIcon');
    const profileDropdown = document.getElementById('profileDropdown');
    const profileInfoDiv = document.getElementById('profileInfo');
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const checkoutButton = document.getElementById('checkoutButton');
    const cartContainer = document.getElementById('cart-items');
    const orderTotalDiv = document.getElementById('orderTotal');

    // Hamburger menu toggle
    function toggleMenu() {
      const isActive = sideMenu.style.display === 'block';
      sideMenu.style.display = isActive ? 'none' : 'block';
      menuToggle.setAttribute('aria-expanded', !isActive);
    }
    menuToggle.addEventListener('click', toggleMenu);
    menuToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleMenu();
      }
    });
    window.addEventListener('click', (e) => {
      if (!sideMenu.contains(e.target) && !menuToggle.contains(e.target)) {
        sideMenu.style.display = 'none';
        menuToggle.setAttribute('aria-expanded', false);
      }
    });

    // Profile dropdown toggle
    function toggleProfileDropdown() {
      const isActive = profileDropdown.classList.toggle('active');
      profileIcon.setAttribute('aria-expanded', isActive);
    }
    profileIcon.addEventListener('click', toggleProfileDropdown);
    profileIcon.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleProfileDropdown();
      }
    });
    window.addEventListener('click', (e) => {
      if (!profileIcon.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.remove('active');
        profileIcon.setAttribute('aria-expanded', false);
      }
    });

    // Fetch user profile data from backend
    async function loadProfile() {
      try {
        const res = await fetch('/api/profile', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 401) {
          alert('Session expired or unauthorized. Please log in again.');
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        const data = await res.json();

        // Calculate total spent from orders
        let totalSpent = 0;
        if (data.orders && Array.isArray(data.orders)) {
          data.orders.forEach(order => {
            order.forEach(item => {
              const priceNum = parseFloat(item.price.replace('$', '')) || 0;
              totalSpent += priceNum;
            });
          });
        }

        profileInfoDiv.innerHTML = `
          <strong>${data.username}</strong><br>
          Balance: $${data.balance.toFixed(2)}<br>
          Spent: $${totalSpent.toFixed(2)}<br>
          Total: $${(data.balance + totalSpent).toFixed(2)}<br>
          Joined: ${data.joinDate || 'Unknown'}<br>
          Orders: ${data.orders ? data.orders.length : 0}
        `;

        // Now fetch the cart using username/email from profile
        fetchCart(data.username);

      } catch (error) {
        console.error('Error loading profile:', error);
        profileInfoDiv.textContent = 'Failed to load profile data';
      }
    }

    // Fetch cart for current user
    async function fetchCart(username) {
      try {
        const res = await fetch(`/api/cart/${username}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 401) {
          alert('Unauthorized access. Please log in again.');
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        if (!res.ok) return;
        const cart = await res.json();
        renderCart(cart);
      } catch (error) {
        console.error('Error fetching cart:', error);
      }
    }

    // Render cart items
    function renderCart(cart) {
      cartContainer.innerHTML = '';
      let total = 0;

      if (!cart.length) {
        cartContainer.innerHTML = '<p>Your cart is empty.</p>';
        orderTotalDiv.textContent = '';
        checkoutButton.disabled = true;
        checkoutButton.setAttribute('aria-disabled', 'true');
        return;
      }

      cart.forEach((item, index) => {
        total += item.price;
        const div = document.createElement('div');
        div.className = 'item';
        div.tabIndex = 0;
        div.innerHTML = `
          <strong>${item.name}</strong> - $${item.price.toFixed(2)}
          <button class="remove-btn" aria-label="Remove ${item.name} from cart" data-index="${index}">‚ùå Remove</button>
        `;
        cartContainer.appendChild(div);
      });

      orderTotalDiv.textContent = `Total: $${total.toFixed(2)}`;
      checkoutButton.disabled = false;
      checkoutButton.setAttribute('aria-disabled', 'false');

      document.querySelectorAll('.remove-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.getAttribute('data-index'));
          await removeFromCart(idx);
        });
      });
    }

    // Remove item from cart
    async function removeFromCart(index) {
      try {
        const res = await fetch(`/api/cart/${profileInfoDiv.querySelector('strong').textContent}`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ removeIndex: index }),
        });
        if (res.ok) fetchCart(profileInfoDiv.querySelector('strong').textContent);
      } catch (error) {
        console.error('Error removing item:', error);
      }
    }

    // Place order
    async function placeOrder() {
      try {
        const username = profileInfoDiv.querySelector('strong').textContent;
        const response = await fetch(`/api/checkout/${username}`, { 
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await response.json();

        if (response.ok) {
          alert('Order placed successfully! New balance: $' + data.balance.toFixed(2));
          window.location.href = '/orders';
        } else {
          alert(data.error || 'Checkout failed');
        }
      } catch (error) {
        alert('Error connecting to server');
        console.error(error);
      }
    }

    checkoutButton.addEventListener('click', placeOrder);

    loadProfile();
  </script>
</body>
</html>
